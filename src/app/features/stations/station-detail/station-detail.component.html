<div class="station-detail-container">
  <!-- Header -->
  @if (!translationsLoading()) {
    <div class="page-header">
      <button mat-icon-button (click)="goBack()" class="back-button">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <div class="header-content">
        <h1 class='page-title'>
          {{ translationService.getReactive('stationDetail.title') }}
          <span
            class="realtime-indicator"
            [class.active]="realtimeActive()"
            aria-hidden="true"
          ></span>
        </h1>
      </div>
    </div>
  }

  <!-- Loading State -->
  @if (loading() || translationsLoading() || initializing()) {
    <div class="loading-container">
      <app-loading-spinner></app-loading-spinner>
      @if (translationsLoading()) {
        <p>Loading...</p>
      } @else {
        <p>{{ translationService.getReactive('stationDetail.loadingStation') }}</p>
      }
    </div>
  }

  <!-- Error State -->
  @if (error() && !loading() && !translationsLoading() && !initializing()) {
    <div class="error-container">
      <app-error-message [message]="error()!"></app-error-message>
      <button mat-raised-button color="primary" (click)="loadStationDetail()">
        <mat-icon>refresh</mat-icon>
        {{ translationService.getReactive('common.buttons.retry') }}
      </button>
    </div>
  }

  <!-- Station Details -->
  @if (stationDetail() && !loading() && !error() && !translationsLoading() && !initializing()) {
    <div class="station-details">
    <!-- Station Name -->
    <div class="station-name-header">
      <mat-icon [class]="getStatusIconClass()">{{ getStatusIcon() }}</mat-icon>
      <span class="station-name">{{ stationDetail()!.title || stationDetail()!.charge_point_id }}</span>
    </div>

    <!-- Status Information with Map -->
    <mat-expansion-panel class="status-panel">
      <mat-expansion-panel-header>
        <mat-panel-title>
          {{ translationService.getReactive('stationDetail.statusInformation') }}
        </mat-panel-title>
        <mat-panel-description>
          <mat-chip [class]="getStatusChipClass(stationDetail()!.status)" class="header-chip">
            {{ stationDetail()!.status }}
          </mat-chip>
          <mat-chip [class]="stationDetail()!.is_online ? 'online' : 'offline'" class="header-chip">
            {{ stationDetail()!.is_online ? translationService.getReactive('stationDetail.status.online') : translationService.getReactive('stationDetail.status.offline') }}
          </mat-chip>
        </mat-panel-description>
      </mat-expansion-panel-header>

      <div class="status-map-container">
        <!-- Status Grid -->
        <div class="status-content">
          <div class="status-grid">
            <div class="status-item">
              <mat-chip [class]="getStatusChipClass(stationDetail()!.status)">
                {{ stationDetail()!.status }}
              </mat-chip>
              <span class="status-label">{{ translationService.getReactive('stationDetail.labels.currentStatus') }}</span>
            </div>

            <div class="status-item">
              <mat-chip [class]="getErrorChipClass(stationDetail()!.error_code)">
                {{ stationDetail()!.error_code }}
              </mat-chip>
              <span class="status-label">{{ translationService.getReactive('stationDetail.labels.errorCode') }}</span>
            </div>

            <div class="status-item">
              <mat-chip [class]="stationDetail()!.is_online ? 'online' : 'offline'">
                {{ stationDetail()!.is_online ? translationService.getReactive('stationDetail.status.online') : translationService.getReactive('stationDetail.status.offline') }}
              </mat-chip>
              <span class="status-label">{{ translationService.getReactive('stationDetail.labels.connection') }}</span>
            </div>

            <div class="status-item">
              <mat-chip [class]="stationDetail()!.is_enabled ? 'enabled' : 'disabled'">
                {{ stationDetail()!.is_enabled ? translationService.getReactive('stationDetail.status.enabled') : translationService.getReactive('stationDetail.status.disabled') }}
              </mat-chip>
              <span class="status-label">{{ translationService.getReactive('stationDetail.labels.availability') }}</span>
            </div>
          </div>

          @if (stationDetail()!.info) {
            <div class="status-info">
              <p><strong>{{ translationService.getReactive('stationDetail.labels.info') }}</strong> {{ stationDetail()!.info }}</p>
            </div>
          }

          <div class="status-updated">
            <p><strong>{{ translationService.getReactive('stationDetail.labels.statusUpdated') }}</strong> {{ getTimeAgo(stationDetail()!.event_time) }}</p>
          </div>
        </div>

        <!-- Map and Address Section -->
        <div class="map-address-section">
          @if (stationDetail()!.address) {
            <div class="address-info">
              <mat-icon>location_on</mat-icon>
              <span>{{ stationDetail()!.address }}</span>
            </div>
          }
          @if (stationDetail()!.location && stationDetail()!.location.latitude && stationDetail()!.location.longitude) {
            <div class="map-container">
              <app-small-map
                [latitude]="stationDetail()!.location.latitude"
                [longitude]="stationDetail()!.location.longitude"
                [title]="stationDetail()!.title"
                [height]="'100%'"
                [zoom]="15">
              </app-small-map>
            </div>
          }
        </div>
      </div>
    </mat-expansion-panel>

    <!-- Connectors -->
    <div class="connectors-section">
      <div class="connectors-content">
        <div class="connectors-grid">
          @for (connector of stationDetail()!.connectors | sortByConnectorId; track connector.connector_id) {
            <div 
              class="connector-item"
              [class.available]="isAvailable(connector.status)"
              [class.occupied]="connector.status === 'Occupied'"
              [class.out-of-order]="connector.status === 'OutOfOrder'"
              [class.updated]="isConnectorUpdated(connector.connector_id)">
              
              <div class="connector-header">
                <h4>{{ translationService.getReactive('stationDetail.labels.connector') }} {{ (connector.connector_id_name || connector.connector_id) }}</h4>
                <div class="connector-status-actions">
                  @if (connector.current_transaction_id > 0) {
                    <button 
                      mat-button 
                      class="transaction-id-button"
                      (click)="openTransactionDetails(connector.current_transaction_id, $event)"
                      [matTooltip]="translationService.getReactive('stationDetail.tooltips.viewTransaction')"
                    >
                      <mat-icon>receipt</mat-icon>
                      #{{ connector.current_transaction_id }}
                    </button>
                  }
                  <mat-chip [class]="getConnectorStatusClass(connector.status)">
                    {{ connector.status }}
                  </mat-chip>
                </div>
              </div>
            
            <div class="connector-details">
              <div class="connector-info">
                <span class="connector-label">{{ translationService.getReactive('stationDetail.labels.type') }}</span>
                <span class="connector-value">{{ connector.type }}</span>
              </div>

              <div class="connector-info">
                <span class="connector-label">{{ translationService.getReactive('stationDetail.labels.power') }}</span>
                <span class="connector-value">{{ connector.power }} kW</span>
              </div>
            </div>

              @if (connector.info) {
                <div class="connector-status-info">
                  <p><strong>{{ translationService.getReactive('stationDetail.labels.info') }}</strong> {{ connector.info }}</p>
                </div>
              }
            </div>
          }
        </div>
        
        <!-- Start Charge Button -->
        @if (hasAvailableConnectors()) {
          <div class="start-charge-section">
            <button 
              mat-button 
              color="primary" 
              class="start-charge-button"
              (click)="startCharge()">
              <mat-icon>play_arrow</mat-icon>
              {{ translationService.getReactive('stationDetail.actions.startCharge') }}
            </button>
            <p class="start-charge-info">{{ translationService.getReactive('stationDetail.actions.startChargeInfo') }}</p>
          </div>
        }
      </div>
    </div>
    </div>
  }
</div>

