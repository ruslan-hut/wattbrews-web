<div class="sessions-history-container">
  <!-- Page Header -->
  <div class="page-header">
    <h1 class="page-title">{{ translationService.getReactive('pages.sessions.history.title') }}</h1>
    <p class="page-subtitle">{{ translationService.getReactive('pages.sessions.history.subtitle') }}</p>
  </div>

  <!-- Authentication Loading State -->
  <div class="auth-required-message" *ngIf="authLoading()">
    <mat-spinner diameter="40"></mat-spinner>
    <h3>Checking Authentication...</h3>
    <p>Please wait while we verify your login status.</p>
  </div>

  <!-- Authentication Required Message -->
  <div class="auth-required-message" *ngIf="!authLoading() && !isAuthenticated()">
    <mat-icon class="auth-icon">lock</mat-icon>
    <h3>Authentication Required</h3>
    <p>You need to be logged in to view your session history. Please sign in to continue.</p>
    <button mat-raised-button color="primary" (click)="navigateToLogin()">
      <mat-icon>login</mat-icon>
      Sign In
    </button>
  </div>

  <!-- Statistics Row -->
  <div class="stats-row" *ngIf="!authLoading() && isAuthenticated()">
    <mat-card class="stat-card">
      <mat-card-content>
        <div style="display: flex; align-items: center; gap: 16px;">
          <mat-icon class="stat-icon">battery_charging_full</mat-icon>
          <div>
            <p class="stat-value">{{ totalEnergy().toFixed(1) }}</p>
            <p class="stat-label">Total Energy (kWh)</p>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card">
      <mat-card-content>
        <div style="display: flex; align-items: center; gap: 16px;">
          <mat-icon class="stat-icon">euro_symbol</mat-icon>
          <div>
            <p class="stat-value">€{{ totalCost().toFixed(2) }}</p>
            <p class="stat-label">Total Cost</p>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card">
      <mat-card-content>
        <div style="display: flex; align-items: center; gap: 16px;">
          <mat-icon class="stat-icon">check_circle</mat-icon>
          <div>
            <p class="stat-value">{{ completedSessions() }}</p>
            <p class="stat-label">Completed Sessions</p>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Filters Section -->
  <div class="filters-section" *ngIf="!authLoading() && isAuthenticated()">
    <mat-card class="filters-card">
      <mat-card-content>
        <div class="filters-row">
          <mat-form-field class="search-field">
            <mat-label>Search transactions</mat-label>
            <input 
              matInput 
              placeholder="Search by transaction ID, station name, or ID tag..."
              [value]="searchTerm()"
              (input)="onSearchChange($event.target.value)"
            >
            <mat-icon matSuffix>search</mat-icon>
          </mat-form-field>

          <mat-form-field class="month-filter-field">
            <mat-label>Month</mat-label>
            <input 
              matInput 
              [matDatepicker]="monthPicker"
              placeholder="Select month"
              [value]="monthFilter()"
              (dateChange)="onMonthFilterChange($event.value)"
            >
            <mat-datepicker-toggle matSuffix [for]="monthPicker"></mat-datepicker-toggle>
            <mat-datepicker #monthPicker startView="year"></mat-datepicker>
            <button 
              mat-icon-button 
              matSuffix 
              class="clear-month-button"
              *ngIf="monthFilter()"
              (click)="clearMonthFilter()"
              matTooltip="Clear month filter"
            >
              <mat-icon>clear</mat-icon>
            </button>
          </mat-form-field>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Transactions Section -->
  <div class="transactions-section" *ngIf="!authLoading() && isAuthenticated()">
    <mat-card class="transactions-card">
      <div class="card-header">
        <h2 class="card-title">Transaction History</h2>
        <button 
          mat-icon-button 
          class="refresh-button"
          (click)="refreshTransactions()"
          [disabled]="transactionService.loading()"
        >
          <mat-icon>refresh</mat-icon>
        </button>
      </div>

      <!-- Loading State -->
      <div class="loading-container" *ngIf="transactionService.loading()">
        <mat-spinner diameter="40"></mat-spinner>
        <p>{{ translationService.getReactive('pages.sessions.history.loadingTransactions') }}</p>
      </div>

      <!-- Error State -->
      <div class="error-container" *ngIf="transactionService.error()">
        <mat-icon class="error-icon">error</mat-icon>
        <p>{{ transactionService.error() }}</p>
        <button mat-raised-button color="primary" (click)="refreshTransactions()">
          Retry
        </button>
      </div>

        <!-- Mobile Transactions (Card Layout) -->
        <div class="mobile-transactions" *ngIf="!transactionService.loading() && !transactionService.error()">
          <div class="mobile-transaction-card" *ngFor="let transaction of paginatedTransactions()" (click)="onTransactionClick(transaction)">
            <div class="mobile-transaction-header">
              <div class="mobile-transaction-id">#{{ transaction.transaction_id }}</div>
              <div class="mobile-transaction-status">
                <mat-chip 
                  class="status-chip"
                  [class.completed]="transaction.is_finished"
                  [class.in-progress]="!transaction.is_finished"
                >
                  {{ transaction.is_finished ? 'Completed' : 'In Progress' }}
                </mat-chip>
              </div>
            </div>
            
            <div class="mobile-transaction-details">
              <div class="mobile-detail-row">
                <span class="mobile-detail-label">Station</span>
                <span class="mobile-detail-value">{{ transaction.charge_point_id }}</span>
              </div>
              
              <div class="mobile-detail-row">
                <span class="mobile-detail-label">Connector</span>
                <span class="mobile-detail-value">{{ transaction.connector_id }}</span>
              </div>
              
              <div class="mobile-detail-row">
                <span class="mobile-detail-label">Energy</span>
                <span class="mobile-detail-value energy">{{ formatEnergy(transaction.meter_start, transaction.meter_stop) }} kWh</span>
              </div>
              
              <div class="mobile-detail-row" *ngIf="transaction.is_finished">
                <span class="mobile-detail-label">Duration</span>
                <span class="mobile-detail-value">{{ formatDuration(transaction.time_start, transaction.time_stop) }}</span>
              </div>
              
              <div class="mobile-detail-row" *ngIf="transaction.payment_amount > 0">
                <span class="mobile-detail-label">Cost</span>
                <span class="mobile-detail-value payment">€{{ (transaction.payment_amount / 100).toFixed(2) }}</span>
              </div>
            </div>
            
            <div class="mobile-transaction-time">
              {{ formatDateTime(transaction.time_start) }}
            </div>
          </div>
        </div>

        <!-- Transactions Table (Desktop) -->
        <div *ngIf="!transactionService.loading() && !transactionService.error()">
          <table mat-table [dataSource]="paginatedTransactions()" class="transactions-table" matSort (matSortChange)="onSortChange($event)">
          <!-- Transaction ID Column -->
          <ng-container matColumnDef="transaction_id">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>ID</th>
            <td mat-cell *matCellDef="let transaction">
              <span class="energy-value">#{{ transaction.transaction_id }}</span>
            </td>
          </ng-container>

          <!-- Status Column -->
          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef>Status</th>
            <td mat-cell *matCellDef="let transaction">
              <mat-chip 
                class="status-chip"
                [class.completed]="transaction.is_finished"
                [class.in-progress]="!transaction.is_finished"
              >
                {{ transaction.is_finished ? 'Completed' : 'In Progress' }}
              </mat-chip>
            </td>
          </ng-container>

          <!-- Station Column -->
          <ng-container matColumnDef="station">
            <th mat-header-cell *matHeaderCellDef mat-sort-header="charge_point_id">Station</th>
            <td mat-cell *matCellDef="let transaction">
              <div>
                <div class="energy-value">{{ transaction.charge_point_id }}</div>
                <div style="font-size: 0.8rem; color: #666;">
                  Connector {{ transaction.connector_id }}
                </div>
              </div>
            </td>
          </ng-container>

          <!-- Energy Column -->
          <ng-container matColumnDef="energy">
            <th mat-header-cell *matHeaderCellDef mat-sort-header="energy">Energy</th>
            <td mat-cell *matCellDef="let transaction">
              <span class="energy-value">
                {{ formatEnergy(transaction.meter_start, transaction.meter_stop) }} kWh
              </span>
            </td>
          </ng-container>

          <!-- Duration Column -->
          <ng-container matColumnDef="duration">
            <th mat-header-cell *matHeaderCellDef>Duration</th>
            <td mat-cell *matCellDef="let transaction">
              <span *ngIf="transaction.is_finished; else inProgressDuration">
                {{ formatDuration(transaction.time_start, transaction.time_stop) }}
              </span>
              <ng-template #inProgressDuration>
                <span style="color: #ff9800;">In Progress</span>
              </ng-template>
            </td>
          </ng-container>

          <!-- Payment Column -->
          <ng-container matColumnDef="payment">
            <th mat-header-cell *matHeaderCellDef mat-sort-header="payment_amount">Payment</th>
            <td mat-cell *matCellDef="let transaction">
              <span *ngIf="transaction.payment_amount > 0; else noPayment" class="payment-amount">
                €{{ (transaction.payment_amount / 100).toFixed(2) }}
              </span>
              <ng-template #noPayment>
                <span style="color: #999;">Free</span>
              </ng-template>
            </td>
          </ng-container>

          <!-- Start Time Column -->
          <ng-container matColumnDef="start_time">
            <th mat-header-cell *matHeaderCellDef mat-sort-header="time_start">Start Time</th>
            <td mat-cell *matCellDef="let transaction">
              <div>
                <div>{{ formatDateTime(transaction.time_start) }}</div>
                <div style="font-size: 0.8rem; color: #666;">
                  {{ formatRelativeTime(transaction.time_start) }}
                </div>
              </div>
            </td>
          </ng-container>

          <!-- End Time Column -->
          <ng-container matColumnDef="end_time">
            <th mat-header-cell *matHeaderCellDef>End Time</th>
            <td mat-cell *matCellDef="let transaction">
              <div *ngIf="transaction.is_finished; else inProgressEnd">
                <div>{{ formatDateTime(transaction.time_stop) }}</div>
                <div style="font-size: 0.8rem; color: #666;">
                  {{ formatRelativeTime(transaction.time_stop) }}
                </div>
              </div>
              <ng-template #inProgressEnd>
                <span style="color: #ff9800;">In Progress</span>
              </ng-template>
            </td>
          </ng-container>

          <!-- Actions Column -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Actions</th>
            <td mat-cell *matCellDef="let transaction">
              <button 
                mat-icon-button 
                (click)="onTransactionClick(transaction)"
                matTooltip="View Details"
              >
                <mat-icon>visibility</mat-icon>
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr 
            mat-row 
            *matRowDef="let transaction; columns: displayedColumns;"
            class="transaction-row"
            (click)="onTransactionClick(transaction)"
          ></tr>
        </table>

        <!-- No Transactions State -->
        <div class="no-transactions" *ngIf="paginatedTransactions().length === 0">
          <mat-icon class="no-data-icon">receipt_long</mat-icon>
          <h3>{{ translationService.getReactive('pages.sessions.history.noTransactions') }}</h3>
          <p *ngIf="searchTerm()">
            Try adjusting your search criteria
          </p>
          <p *ngIf="!searchTerm()">
            You haven't made any charging sessions yet
          </p>
        </div>

        <!-- Pagination -->
        <mat-paginator
          *ngIf="totalTransactions() > 0"
          [length]="totalTransactions()"
          [pageSize]="pageSize()"
          [pageIndex]="currentPage()"
          [pageSizeOptions]="[5, 10, 25, 50]"
          (page)="onPageChange($event)"
          showFirstLastButtons
        ></mat-paginator>
      </div>
    </mat-card>
  </div>
</div>
