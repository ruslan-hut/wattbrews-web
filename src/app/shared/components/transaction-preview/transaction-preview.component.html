<div class="transaction-preview-container">
  <!-- Header -->
  <div class="preview-header">
    <div class="header-left">
      <div class="transaction-title">
        <mat-icon>receipt</mat-icon>
        <span class="transaction-id">{{ translationService.getReactive('transactionDetails.title') }} #{{ transactionDetail()?.transaction_id }}</span>
      </div>
<!--      @if (transactionDetail()) {-->
<!--        <mat-chip [class]="'status-chip ' + getStatusClass(transactionDetail()!.status)">-->
<!--          {{ transactionDetail()!.status }}-->
<!--          @if (transactionDetail()!.is_charging) {-->
<!--            <span class="live-dot active" aria-hidden="true"></span>-->
<!--          }-->
<!--        </mat-chip>-->
<!--      }-->
    </div>
    <button mat-icon-button (click)="closeDialog($event)" class="close-button">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <!-- Loading State -->
  @if (loading() || translationsLoading()) {
    <div class="loading-container">
      <mat-spinner diameter="40"></mat-spinner>
      <p>{{ translationsLoading() ? 'Loading...' : translationService.getReactive('transactionDetails.loading') }}</p>
    </div>
  }

  <!-- Error State -->
  @if (error() && !loading() && !translationsLoading()) {
    <div class="error-container">
      <mat-icon class="error-icon">error</mat-icon>
      <p>{{ error() }}</p>
      <button mat-raised-button color="primary" (click)="loadTransactionDetail()">
        {{ translationService.getReactive('transactionDetails.retry') }}
      </button>
    </div>
  }

  <!-- Transaction Details -->
  @if (!loading() && !error() && !translationsLoading() && transactionDetail()) {
    <mat-dialog-content>
      <!-- Station Info -->
      <div class="station-info">
        <mat-icon>ev_station</mat-icon>
        <span>{{ transactionDetail()!.charge_point_title }}</span>
      </div>

      <!-- Overview Grid -->
      <div class="overview-section">
        <div class="overview-grid">
          <div class="overview-item">
            <mat-icon>ev_station</mat-icon>
            <div class="item-content">
              <span class="item-label">{{ translationService.getReactive('transactionDetails.overview.station') }}</span>
              <span class="item-value">{{ transactionDetail()!.charge_point_id }}</span>
            </div>
          </div>
          <div class="overview-item">
            <mat-icon>power</mat-icon>
            <div class="item-content">
              <span class="item-label">{{ translationService.getReactive('transactionDetails.overview.connector') }}</span>
              <span class="item-value">{{ transactionDetail()!.connector.connector_id_name }} ({{ transactionDetail()!.connector.type }})</span>
            </div>
          </div>
          <div class="overview-item">
            <mat-icon>schedule</mat-icon>
            <div class="item-content">
              <span class="item-label">{{ translationService.getReactive('transactionDetails.overview.duration') }}</span>
              <span class="item-value">{{ formatDuration(transactionDetail()!.duration || 0) }}</span>
            </div>
          </div>
          <div class="overview-item">
            <mat-icon>battery_charging_full</mat-icon>
            <div class="item-content">
              <span class="item-label">{{ translationService.getReactive('transactionDetails.overview.energyConsumed') }}</span>
              <span class="item-value">{{ formatEnergy(transactionDetail()!.consumed || 0) }} kWh</span>
            </div>
          </div>
          <div class="overview-item">
            <mat-icon>euro_symbol</mat-icon>
            <div class="item-content">
              <span class="item-label">{{ translationService.getReactive('transactionDetails.overview.cost') }}</span>
              <span class="item-value">â‚¬{{ ((transactionDetail()!.price || 0) / 100).toFixed(2) }}</span>
            </div>
          </div>
          <div class="overview-item">
            <mat-icon>flash_on</mat-icon>
            <div class="item-content">
              <span class="item-label">{{ translationService.getReactive('transactionDetails.overview.averagePower') }}</span>
              <span class="item-value">{{ calculateAveragePower() }}</span>
            </div>
          </div>
          <div class="overview-item">
            <mat-icon>access_time</mat-icon>
            <div class="item-content">
              <span class="item-label">{{ translationService.getReactive('transactionDetails.timing.started') }}</span>
              <span class="item-value">{{ formatDateTime(transactionDetail()!.time_started || '') }}</span>
            </div>
          </div>
          @if (!transactionDetail()!.is_charging) {
            <div class="overview-item">
              <mat-icon>access_time_filled</mat-icon>
              <div class="item-content">
                <span class="item-label">{{ translationService.getReactive('transactionDetails.timing.ended') }}</span>
                <span class="item-value">{{ formatEndTime(transactionDetail()!.time_started || '', transactionDetail()!.duration || 0) }}</span>
              </div>
            </div>
          }
        </div>
      </div>

      <!-- Location Section -->
      @if (transactionDetail()!.charge_point_address) {
        <div class="location-section">
          <div class="location-content">
            <mat-icon>location_on</mat-icon>
            <span>{{ transactionDetail()!.charge_point_address }}</span>
          </div>
        </div>
      }

      <!-- Map Section -->
      @if (hasLocation()) {
        <div class="map-section">
          <div class="map-container">
            <app-small-map
              [latitude]="getLatitude()"
              [longitude]="getLongitude()"
              [title]="transactionDetail()!.charge_point_title || ''"
              [zoom]="15"
              height="200px">
            </app-small-map>
          </div>
        </div>
      }

      <!-- Energy Chart Section -->
      @if (hasMeterValues()) {
        <div class="chart-section">
          <div class="chart-container">
            <app-energy-chart [meterValues]="transactionDetail()!.meter_values || []"></app-energy-chart>
          </div>
        </div>
      }
    </mat-dialog-content>

    <!-- Actions -->
    <mat-dialog-actions>
      <button mat-button (click)="closeDialog($event)">{{ translationService.getReactive('transactionDetails.close') }}</button>
    </mat-dialog-actions>
  }
</div>
